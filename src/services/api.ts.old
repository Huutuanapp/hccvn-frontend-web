import axios, { AxiosInstance } from 'axios';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000';

export const apiClient: AxiosInstance = axios.create({
  baseURL: API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});

apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('hccvn_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  const role = localStorage.getItem('hccvn_role');
  if (role) {
    config.headers['X-Role'] = role;
  }
  return config;
});

apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      localStorage.removeItem('hccvn_token');
      localStorage.removeItem('hccvn_user');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export interface BeneficialOwner {
  citizen_id: string;
  full_name: string;
  ownership_percentage: number;
  control_method: string;
}

export interface BusinessLine {
  code: string;
  description_vi: string;
  is_licensed: boolean;
}

export interface Deficiency {
  code: string;
  category: string;
  description_vi: string;
  instruction_vi: string;
  legal_basis_vi: string;
}

export interface CaseDetail {
  procedure_id: string;
  procedure_type: string;
  status: string;
  result_status: string;
  enterprise_name: string;
  tin: string;
  address: string;
  submitter_name: string;
  submitter_citizen_id: string;
  beneficial_owners: BeneficialOwner[];
  business_lines: BusinessLine[];
  deficiencies: Deficiency[];
  validation_passed: boolean;
  validation_errors: string[];
  signing_status: string;
  ai_analysis?: {
    confidence_score: number;
    risk_level: string;
    recommendations: string[];
    extracted_entities: Record<string, any>;
  };
  created_at: string;
  submitted_at: string | null;
  completed_at: string | null;
}

export interface Document {
  id: string;
  name: string;
  type: string;
  size: number;
  processing_status: string;
  approval_status: string;
  ai_analysis?: {
    summary: string;
    key_points: string[];
  };
  uploaded_at: string;
  uploaded_by: string;
}

export const casesAPI = {
  getAll: async (params?: {
    status?: string;
    type?: string;
    search?: string;
    page?: number;
    limit?: number;
  }) => {
    const response = await apiClient.get('/api/bls/cases', { params });
    return response.data;
  },

  getById: async (id: string): Promise<CaseDetail> => {
    const response = await apiClient.get(`/api/bls/cases/procedure/${id}`);
    return response.data;
  },

  getStats: async () => {
    const response = await apiClient.get('/api/bls/cases/stats');
    return response.data;
  },

  review: async (id: string, decision: string, reason?: string) => {
    const response = await apiClient.post(`/api/bls/review/${id}`, {
      decision,
      reason,
    });
    return response.data;
  },
};

export const signingAPI = {
  getAwaitingSignature: async () => {
    const response = await apiClient.get('/api/bls/cases', {
      params: { signing_status: 'AWAITING_SIGNATURE' },
    });
    return response.data;
  },

  sign: async (id: string) => {
    const response = await apiClient.post(`/api/bls/sign/${id}`);
    return response.data;
  },
};

export const aiTeachingAPI = {
  getDocuments: async () => {
    const response = await apiClient.get('/api/bls/ai-teaching/documents');
    return response.data;
  },

  uploadDocument: async (formData: FormData) => {
    const response = await apiClient.post('/api/bls/ai-teaching/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
    });
    return response.data;
  },

  approveDocument: async (id: string, decision: string, reason?: string) => {
    const response = await apiClient.post(`/api/bls/ai-teaching/documents/${id}/approve`, {
      decision,
      reason,
    });
    return response.data;
  },
};
